-- Generated by Chef for <%= node["hostname"] %>.
-- Local modifications will be overwritten.

CREATE USER IF NOT EXISTS '<%=node["percona"]["server"]["replication"]["username"]%>'@'%' IDENTIFIED BY '<%= @replication_password %>';
<% if node["percona"]["server"]["replication"]["ssl_enabled"] %>
ALTER USER '<%=node["percona"]["server"]["replication"]["username"]%>'@'%' REQUIRE SSL;
<% end %>
SET PASSWORD FOR '<%=node["percona"]["server"]["replication"]["username"]%>'@'%' = PASSWORD('<%= @replication_password %>');


GRANT REPLICATION SLAVE ON *.* TO '<%=node["percona"]["server"]["replication"]["username"]%>'@'%';

<% unless node["percona"]["server"]["replication"]["host"].empty? %>
STOP SLAVE;
CHANGE MASTER TO
  MASTER_HOST='<%= node["percona"]["server"]["replication"]["host"] %>',
  MASTER_PORT=<%= node["percona"]["server"]["replication"]["port"] %>,
  MASTER_USER='<%= node["percona"]["server"]["replication"]["username"] %>',
  <% if node["percona"]["server"]["replication"]["ssl_enabled"] %>
  MASTER_SSL=1,
  MASTER_SSL_CA='/etc/mysql/ssl/cacert.pem',
  MASTER_SSL_CERT='/etc/mysql/ssl/client-cert.pem',
  MASTER_SSL_KEY='/etc/mysql/ssl/client-key.pem',
  <% end %>
  <% if node["percona"]["server"]["replication"]["auto_position"] %>
  MASTER_AUTO_POSITION=1,
  <%end%>
  MASTER_PASSWORD='<%= @replication_password %>';
START SLAVE;
<% end %>
